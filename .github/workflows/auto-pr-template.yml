name: Apply PR Template

on:
  pull_request:
    types: [opened, edited]

permissions:
  contents: read         # necessário para actions/checkout ler arquivos
  pull-requests: write   # necessário para atualizar o PR via API

jobs:
  apply-template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine template file
        id: pick
        run: |
          echo "target=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          if [[ "${{ github.event.pull_request.base.ref }}" == "develop" ]]; then
            echo "file=.github/PULL_REQUEST_TEMPLATE/develop.md" >> $GITHUB_OUTPUT
          else
            echo "file=.github/PULL_REQUEST_TEMPLATE/main.md" >> $GITHUB_OUTPUT
          fi

      - name: Read template if exists
        id: read
        run: |
          FILE="${{ steps.pick.outputs.file }}"
          if [[ -f "$FILE" ]]; then
            # preserve newlines safely
            CONTENT=$(sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' "$FILE")
            echo "$CONTENT" > template.txt
            echo "found=true" >> $GITHUB_OUTPUT
            echo "path=template.txt" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Update PR body with template
        if: steps.read.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync(process.env.TEMPLATE_PATH, { encoding: 'utf8' });
            const pr_number = context.payload.pull_request.number;
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number,
              body: body
            });
          env:
            TEMPLATE_PATH: ${{ steps.read.outputs.path }}

      - name: Comment when template not found
        if: steps.read.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: "⚠️ Template esperado não encontrado em `.github/PULL_REQUEST_TEMPLATE/`. Nenhuma alteração aplicada."
            });
